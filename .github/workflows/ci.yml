name: JSONPlaceholder API Tests

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop, feature/*]
  workflow_dispatch:


jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      BASE_URL: ${{ secrets.BASE_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Cache Maven repository
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Run tests
        id: run_tests
        env:
          MAVEN_OPTS: "-Xmx1g"
          BASE_URL: ${{ secrets.BASE_URL }}
        run: mvn -B clean test -DtrimStackTrace=false -Dsurefire.printSummary=true -Dheadless=true

      - name: Generate Allure report
        if: always()
        run: mvn allure:report

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ github.run_id }}
          path: target/allure-results

      - name: Upload Allure HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ github.run_id }}
          path: target/site/allure-maven-plugin

      - name: Extract test results
        if: always()
        id: test_results
        run: |
          COMMIT_SHA=${GITHUB_SHA:0:7}

          TOTAL=0
          FAILED=0
          SKIPPED=0

          if ls target/surefire-reports/*.txt >/dev/null 2>&1; then
            while read -r line; do
              RUN=$(echo "$line" | sed -n 's/.*Tests run: \([0-9]*\).*/\1/p')
              FAIL=$(echo "$line" | sed -n 's/.*Failures: \([0-9]*\).*/\1/p')
              ERR=$(echo "$line" | sed -n 's/.*Errors: \([0-9]*\).*/\1/p')
              SKIP=$(echo "$line" | sed -n 's/.*Skipped: \([0-9]*\).*/\1/p')

              if [ -n "$RUN" ]; then
                TOTAL=$((TOTAL + RUN))
                FAILED=$((FAILED + FAIL + ERR))
                SKIPPED=$((SKIPPED + SKIP))
              fi
            done < <(grep -h "Tests run:" target/surefire-reports/*.txt || true)
          fi

          PASSED=$((TOTAL - FAILED - SKIPPED))

          # Extract failing test names using [FAIL] marker from surefire XML reports (system-err)
          FAILING_TESTS_RAW=$(grep -oh '\[FAIL\][^<]*' target/surefire-reports/TEST-*.xml 2>/dev/null \
            | sed 's/ ==>.*//' \
            | sort -u || true)

          # Escape newlines for JSON payload (replace newline with literal \n)
          FAILING_TESTS_JSON=$(echo "$FAILING_TESTS_RAW" | sed ':a;N;$!ba;s/\n/\\n/g')

          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
          echo "failing_tests_raw<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILING_TESTS_RAW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "failing_tests_json<<EOF" >> $GITHUB_OUTPUT
          echo "$FAILING_TESTS_JSON" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload Surefire reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: surefire-reports-${{ github.run_id }}
          path: target/surefire-reports

      - name: Slack notify
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": "${{ job.status == 'success' && 'âœ… *CI Pipeline Passed*' || 'ğŸš¨ *CI Pipeline Failed*' }}\n\nğŸ“¦ *Repository:* ${{ github.repository }}\nğŸŒ¿ *Branch:* ${{ github.ref_name }}\nğŸ§¾ *Commit:* ${{ steps.test_results.outputs.commit_sha }}\nğŸ“Š *Status:* ${{ job.status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ˆ *Test Summary*\nâ€¢ Total Tests: ${{ steps.test_results.outputs.total }}\nâ€¢ Failed: ${{ steps.test_results.outputs.failed }} ${{ job.status == 'success' && '' || 'âŒ' }}\nâ€¢ Skipped: ${{ steps.test_results.outputs.skipped }}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n${{ job.status == 'success' && 'âœ… *All Tests Passed*' || format('ğŸ”´ *Failing Tests*\n{0}', steps.test_results.outputs.failing_tests_json) }}\n\nğŸ”— *Run Details:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Email notify
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI ${{ job.status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}: ${{ github.repository }}"
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          body: |
            ${{ job.status == 'success' && 'âœ… *CI Pipeline Passed*' || 'ğŸš¨ *CI Pipeline Failed*' }}

            ğŸ“¦ *Repository:* ${{ github.repository }}
            ğŸŒ¿ *Branch:* ${{ github.ref_name }}
            ğŸ§¾ *Commit:* ${{ steps.test_results.outputs.commit_sha }}
            ğŸ“Š *Status:* ${{ job.status == 'success' && 'âœ… PASSED' || 'âŒ FAILED' }}

            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            ğŸ“ˆ *Test Summary*
            â€¢ Total Tests: ${{ steps.test_results.outputs.total }}
            â€¢ Failed: ${{ steps.test_results.outputs.failed }} ${{ job.status == 'success' && '' || 'âŒ' }}
            â€¢ Skipped: ${{ steps.test_results.outputs.skipped }}
            â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

            ${{ job.status == 'success' && 'âœ… *All Tests Passed*' || 'ğŸ”´ *Failing Tests*' }}
            ${{ job.status == 'success' && '' || steps.test_results.outputs.failing_tests_raw }}

            ğŸ”— *Run Details:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

